#!/bin/bash

# LLMunix LLM Interpreter CLI Wrapper
# Provides convenient access to the LLM-driven runtime

set -e

# Check if Python is available
if ! command -v python3 &> /dev/null; then
    echo "‚ùå Python 3 is required but not found"
    exit 1
fi

# Get the directory of this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if .env file exists
if [ ! -f "$SCRIPT_DIR/.env" ]; then
    echo "‚ö†Ô∏è  .env file not found. Create from example.env:"
    echo "   cp example.env .env"
    echo "   # Edit .env with your OpenAI API key"
    exit 1
fi

# Parse command
COMMAND=""
GOAL=""
INTERACTIVE=""

# Handle different argument patterns
if [ "$1" = "boot" ]; then
    COMMAND="boot"
elif [ "$1" = "interactive" ] || [ "$1" = "-i" ] || [ "$1" = "--interactive" ]; then
    COMMAND="interactive"
elif [ "$1" = "execute:" ]; then
    COMMAND="execute"
    GOAL="$2"
    # Check for interactive flag
    if [ "$3" = "-i" ] || [ "$3" = "--interactive" ]; then
        INTERACTIVE="--interactive"
    fi
elif [[ "$1" == execute:* ]]; then
    COMMAND="execute"
    GOAL="${1#execute:}"
    # Remove leading/trailing quotes and whitespace
    GOAL=$(echo "$GOAL" | sed 's/^[[:space:]]*"//; s/"[[:space:]]*$//' | sed "s/^[[:space:]]*'//; s/'[[:space:]]*$//")
    # Check for interactive flag
    if [ "$2" = "-i" ] || [ "$2" = "--interactive" ]; then
        INTERACTIVE="--interactive"
    fi
elif [ "$1" = "execute" ]; then
    COMMAND="execute"
    shift
    # Check for interactive flag at the end
    if [ "${@: -1}" = "-i" ] || [ "${@: -1}" = "--interactive" ]; then
        INTERACTIVE="--interactive"
        # Remove the interactive flag from the goal
        set -- "${@:1:$(($#-1))}"
    fi
    GOAL="$*"
else
    echo "LLMunix LLM Interpreter - Autonomous Markdown Operating System"
    echo ""
    echo "Usage:"
    echo "  $0 boot                                    # Boot LLMunix OS"
    echo "  $0 interactive                             # Start interactive session"
    echo "  $0 execute: \"Your goal here\"               # Execute goal"
    echo "  $0 execute \"Your goal here\"                # Alternative syntax"
    echo "  $0 execute: \"Your goal here\" -i            # Execute and enter interactive mode"
    echo ""
    echo "Interactive Commands (when in interactive mode):"
    echo "  refine       - Refine and re-execute the last goal"
    echo "  status       - Show workspace status"
    echo "  history      - Show execution history"
    echo "  clear        - Clear workspace"
    echo "  help         - Show help"
    echo "  exit/quit    - Exit interactive session"
    echo ""
    echo "Examples:"
    echo "  $0 boot"
    echo "  $0 interactive"
    echo "  $0 execute: \"Create a Python calculator\""
    echo "  $0 execute: \"Fetch content from https://example.com and summarize\" -i"
    echo ""
    exit 1
fi

# Execute command
cd "$SCRIPT_DIR"

if [ "$COMMAND" = "boot" ]; then
    echo "üöÄ Booting LLMunix with LLM Interpreter..."
    python3 llm_interpreter.py boot
elif [ "$COMMAND" = "interactive" ]; then
    echo "üéØ Starting LLMunix Interactive Session..."
    python3 llm_interpreter.py interactive
elif [ "$COMMAND" = "execute" ]; then
    if [ -z "$GOAL" ]; then
        echo "‚ùå Goal required for execute command"
        exit 1
    fi
    echo "üéØ Executing goal with LLM Interpreter..."
    if [ -n "$INTERACTIVE" ]; then
        python3 llm_interpreter.py execute "$GOAL" $INTERACTIVE
    else
        python3 llm_interpreter.py execute "$GOAL"
    fi
fi